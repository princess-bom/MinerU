# MinerU Electron 내부용 리팩토링 계획서

## 1) 문서 목적
- 본 문서는 MinerU를 개인/지인 소규모 사용 환경에서 macOS, Windows 실행형 앱으로 전환하기 위한 **실행 계획**만 정의한다.

## 2) 목표와 비목표

### 목표 (Goals)
- 기존 Python 기반 MinerU 엔진을 유지하면서 Electron Shell을 추가해 데스크톱 앱 형태로 사용 가능하게 한다.
- 내부 공유 가능한 설치 산출물(`.dmg`/`.zip`, `.exe`)을 생성 가능한 빌드 흐름을 확립한다.
- 최소 기능 MVP(파일 선택, 변환 실행, 진행 상태 확인, 결과 열기)를 안정적으로 제공한다.
- 오류 대응 및 롤백 절차를 문서화해 운영 리스크를 줄인다.

### 비목표 (Non-goals)
- App Store/Microsoft Store 등록 및 심사 대응.
- 대규모 외부 사용자 배포 체계(고객지원, 텔레메트리, 상용 라이선싱).
- 엔진 핵심 알고리즘 재작성 또는 모델 아키텍처 변경.

## 3) 범위 가정 (Scope Assumptions)
- 사용자는 본인 + 지인 소수이며, 공식 배포/상용 배포를 수행하지 않는다.
- 운영체제 타깃은 macOS(Apple Silicon 우선, 필요 시 Intel 고려)와 Windows x64다.
- 내부 배포 채널은 파일 공유(클라우드 드라이브/메신저/사내 스토리지) 기반이다.
- 네트워크가 제한된 환경을 고려하여, 오프라인 실행 가능성을 점진적으로 개선한다.

## 4) 타깃 아키텍처

### 구조 개요
- `Electron App (UI + Orchestration)`
  - 사용자 입력 수집, 작업 시작/취소, 로그 표시, 결과 폴더 열기.
- `Python Engine (MinerU existing core)`
  - 실제 PDF 파싱 및 출력 생성 담당.
- `Execution Bridge`
  - Electron Main Process에서 Python CLI 프로세스를 안전하게 실행/감시.
- `Data & Cache Layer`
  - 설정값, 최근 실행 이력, 모델 캐시 경로를 OS별 표준 위치에 저장.

### 통신 방식
- 1차: **Local Process Execution** (CLI 호출 + stdout/stderr 파싱).
- 2차(선택): Local HTTP API 모드 확장 가능.
- 상태 전달: `queued -> running -> succeeded/failed/cancelled` 표준 상태 모델 사용.

### 보안/격리 원칙
- Renderer에서 직접 시스템 명령 실행 금지.
- Main Process 단일 경로를 통해서만 엔진 실행.
- 사용자 입력 경로 검증(존재 여부, 권한, 확장자 기본 검증).

## 5) 현재 레포 내 디렉터리 구조 제안

```text
MinerU/
  apps/
    desktop/
      package.json
      electron-builder.yml
      src/
        main/
        preload/
        renderer/
      assets/
  mineru/
    ... (기존 Python 엔진)
  scripts/
    desktop/
      build-mac.sh
      build-win.ps1
      smoke-test.sh
  docs/
    en/
      electron_internal_refactor_plan.md
      electron_runbook_internal.md
```

### 설계 의도
- 기존 Python 엔진 디렉터리는 최대한 불변으로 유지한다.
- 데스크톱 앱 관련 변경은 `apps/desktop`에 격리한다.
- 빌드/검증 스크립트를 `scripts/desktop`에 모아 운영 단순성을 확보한다.

## 6) 4-Phase 로드맵 (마일스톤 + 수용 기준)

## Phase 1: 인터페이스 고정 및 실행 계약 정의
### 주요 작업
- CLI 실행 계약 정의(입력/출력 파라미터, 종료 코드, 로그 포맷).
- 앱 상태 모델 및 오류 코드 매핑 표 작성.
- OS별 경로 정책 정의(설정, 캐시, 출력 기본 경로).

### 마일스톤
- `Engine Contract v1` 문서 완료.
- 오류 코드 테이블과 사용자 메시지 매핑 초안 완료.

### 수용 기준 (Acceptance Criteria)
- 동일 입력에 대해 CLI 단독 실행 결과와 앱 호출 결과가 동일해야 한다.
- 종료 코드 0/비0에 대한 처리 규칙이 문서화되어야 한다.

## Phase 2: Electron MVP 구성
### 주요 작업
- Main/Preload/Renderer 기본 골격 구성.
- 파일 선택, 출력 경로 선택, 실행 버튼, 로그 패널, 결과 열기 기능 정의.
- 프로세스 실행/취소/타임아웃 정책 정의.

### 마일스톤
- MVP 사용자 흐름 1개(단일 PDF 처리) 설계 완료.
- 실패/취소 상태 전환 규칙 문서화.

### 수용 기준
- 정상 실행, 실패 실행, 사용자 취소 3가지 흐름의 기대 동작이 문서에 명확해야 한다.
- 앱 재실행 시 최근 경로 복원 정책이 정의되어야 한다.

## Phase 3: 패키징 및 내부 배포 프로세스
### 주요 작업
- macOS: `.dmg` 또는 `.zip` 내부 배포 산출물 기준 확정.
- Windows: `.exe` 설치형 기준 확정.
- Python 런타임 포함 전략(embedded/runtime dependency strategy) 수립.

### 마일스톤
- 플랫폼별 빌드 절차 Runbook 1차 완성.
- 내부 배포 체크리스트(버전, 해시, 설치 가이드) 완성.

### 수용 기준
- macOS/Windows 각각 설치 후 첫 실행까지의 절차가 문서만으로 재현 가능해야 한다.
- 최소 1대씩 실제 설치 검증 체크리스트 통과가 가능해야 한다.

## Phase 4: 운영 안정화 및 회귀 방지
### 주요 작업
- 스모크 테스트 시나리오 정의(정상/실패/권한/대용량/취소).
- 로그 수집/공유 절차 표준화.
- 롤백 기준과 버전 핀닝 정책 확정.

### 마일스톤
- 내부 운영 Runbook v1 완료.
- 릴리스 승인 게이트 정의.

### 수용 기준
- 릴리스 전 게이트 항목 100% 체크 가능해야 한다.
- 문제 발생 시 이전 안정 버전으로 복귀 절차가 30분 내 수행 가능해야 한다.

## 7) macOS/Windows 내부 배포 패키징 전략

### 공통 원칙
- 외부 스토어 배포 없음.
- 내부 버전 명명 규칙: `major.minor.patch-internal.N`.
- 배포물은 해시(SHA256)와 함께 전달.

### macOS
- 1차 권장: `.zip` 우선(게이트키퍼 이슈 최소화), 필요 시 `.dmg` 병행.
- Gatekeeper 경고 대응 가이드(내부 문서) 제공.
- Apple Silicon 우선 지원, Intel은 필요성 발생 시 추가.

### Windows
- 1차 권장: 설치형 `.exe` 1개 표준화.
- 설치 경로와 권한 요구사항을 단순화(기본 사용자 권한 우선).

## 8) 내부용 Signing/Notarization 정책 (Minimalist)
- 기본 정책: 초기 단계에서는 코드서명/공증을 필수 게이트로 두지 않는다.
- 예외 정책: 경고/차단 빈도가 높아 사용성에 영향이 크면 우선순위 상향.
- 적용 순서: Windows code signing -> macOS notarization 순으로 검토.
- 결정 기준: 사용 인원 증가, 설치 실패율, 운영 피드백 빈도.

## 9) 리스크 레지스터 (최소 8개)

| ID | 리스크 | 영향 | 완화 방안 |
|---|---|---|---|
| R1 | Python 런타임/의존성 충돌 | 실행 실패 | OS별 런타임 고정 및 버전 핀닝 |
| R2 | 모델 다운로드 실패/지연 | 초기 사용성 저하 | 재시도 정책, 미러 경로, 오프라인 안내 |
| R3 | 대용량 PDF 처리 중 메모리 급증 | 앱 종료/정지 | 타임아웃, 파일 크기 가이드, 작업 분할 |
| R4 | 경로 권한 문제(Desktop/Network Drive) | 저장 실패 | 기본 출력 경로 안전값 제공, 사전 권한 점검 |
| R5 | 보안 경고(Gatekeeper/Defender) | 설치 이탈 | 내부 설치 가이드, 해시 검증 절차 |
| R6 | Electron-Python IPC 불안정 | 상태 표시 오류 | 상태머신 표준화, 종료 코드 매핑 고정 |
| R7 | 로그 부족으로 원인 분석 지연 | 장애 대응 지연 | 표준 로그 수집 경로/포맷 정의 |
| R8 | 플랫폼별 빌드 결과 상이 | 배포 일관성 저하 | 플랫폼별 빌드 체크리스트 분리 |
| R9 | 숨은 엔진 회귀 버그 | 결과 품질 저하 | 기준 PDF 회귀 세트 운영 |
| R10 | 내부 문서 미흡 | 인수인계 실패 | Runbook/FAQ 동시 유지 |

## 10) MVP 테스트/검증 체크리스트
- [ ] 앱 시작 후 초기 화면이 10초 내 표시된다.
- [ ] 입력 PDF 선택/출력 경로 선택이 정상 동작한다.
- [ ] 변환 실행 시 상태가 `running`으로 전환된다.
- [ ] 성공 시 결과 폴더 열기가 정상 동작한다.
- [ ] 실패 시 사용자 메시지와 로그 경로가 제공된다.
- [ ] 사용자 취소 시 프로세스가 종료되고 상태가 `cancelled`로 전환된다.
- [ ] 잘못된 경로 입력 시 사전 검증 메시지가 표시된다.
- [ ] 200MB+ PDF 시나리오에서 앱이 무응답 없이 종료/완료 처리된다.
- [ ] macOS 1대, Windows 1대에서 설치-실행-삭제까지 확인된다.

## 11) 롤백 계획 및 의사결정 게이트

### 롤백 트리거
- 설치 실패율 급증(예: 20% 이상).
- 변환 성공률 급락 또는 치명적 크래시 반복.
- 주요 경로 권한/보안 경고로 사용 불가 상태 발생.

### 롤백 절차
1. 신규 빌드 배포 중지.
2. 직전 안정 빌드 링크 재배포.
3. 문제 버전 실행 금지 공지(내부 채널).
4. 로그 수집 후 원인 분류(빌드/런타임/엔진/환경).
5. 수정 계획 확정 전까지 핫픽스 배포 보류.

### 의사결정 게이트
- Gate A (Phase 1 종료): 계약 문서가 충분히 명확한가?
- Gate B (Phase 2 종료): MVP 흐름 3종(성공/실패/취소) 정의가 완결되었는가?
- Gate C (Phase 3 종료): 양 플랫폼 설치 절차가 재현 가능한가?
- Gate D (Phase 4 종료): 롤백/운영 문서가 실제 대응에 충분한가?

## 12) 단계별 공수 추정 (소규모 팀 기준)

### 추정
- Phase 1: 2~4일
- Phase 2: 5~8일
- Phase 3: 3~6일
- Phase 4: 2~4일

### 총합
- 낙관: 12일
- 보수: 22일
- 권장 계획: 3~4주(버퍼 포함)

## 13) 최종 정리
- 본 계획은 "빠른 내부 사용 가능"과 "장기 유지 가능"의 균형을 목표로 한다.
- 구현 시작 전, Phase 1 계약 문서(입출력/오류/로그) 확정이 필수 선행 조건이다.
- 구현은 반드시 본 계획의 Gate 순서대로 진행하여 리스크를 단계적으로 통제한다.
